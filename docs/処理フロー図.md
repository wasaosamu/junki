# 純鬼 処理フロー図

> ソースコードの処理の流れをフロー図で表現。

## draw.io（diagrams.net）用ファイル

以下の `.drawio` ファイルを [diagrams.net](https://app.diagrams.net/) で開いて編集・画像エクスポートができます。

| ファイル | 内容 |
|----------|------|
| [diagrams/01_全体フロー.drawio](diagrams/01_全体フロー.drawio) | アプリケーション起動～終了の全体フロー |
| [diagrams/02_メインゲームループ.drawio](diagrams/02_メインゲームループ.drawio) | 1フレーム（60FPS）の処理の流れ |
| [diagrams/03_プレイヤー純鬼AI.drawio](diagrams/03_プレイヤー純鬼AI.drawio) | プレイヤー更新処理 / 純鬼追跡AI |
| [diagrams/04_セーブロード_エンディング.drawio](diagrams/04_セーブロード_エンディング.drawio) | セーブ・ロード処理 / エンディング分岐 |
| [diagrams/05_モジュール依存関係.drawio](diagrams/05_モジュール依存関係.drawio) | モジュール間の呼び出し関係 |

**使い方**: [https://app.diagrams.net/](https://app.diagrams.net/) にアクセス → 「Open Existing Diagram」で上記ファイルを開く

---

## 1. 全体フロー（アプリケーション起動～終了）

```mermaid
flowchart TD
    Start([プログラム起動]) --> Init[Pygame 初期化]
    Init --> CreateWindow[ディスプレイ作成<br>1280x720]
    CreateWindow --> Title[タイトル画面]

    Title -->|はじめる| NewGame[新規ゲーム開始]
    Title -->|つづきから| Load[セーブデータロード]
    Title -->|終了| Quit[終了処理]

    Load --> LoadDB[(SQLite から読み込み)]
    LoadDB --> Restore[ゲーム状態復元]
    Restore --> GameLoop

    NewGame --> GameLoop[メインゲームループ]

    GameLoop -->|ゲームオーバー| GameOver[ゲームオーバー画面]
    GameOver -->|リトライ| GameLoop
    GameOver -->|タイトルへ| Title

    GameLoop -->|脱出成功| Ending[エンディング処理]
    Ending --> EndingBranch{エンディング分岐}
    EndingBranch -->|覚悟| TrueEnd[トゥルーエンド<br>サキの記憶]
    EndingBranch -->|脱出| NormalEnd[ノーマルエンド]
    EndingBranch -->|囚われ| BadEnd[バッドエンド]
    TrueEnd --> Title
    NormalEnd --> Title
    BadEnd --> Title

    GameLoop -->|終了選択| Quit
    Quit --> PygameQuit[pygame.quit]
    PygameQuit --> End([プログラム終了])
```

---

## 2. メインゲームループ 詳細フロー

```mermaid
flowchart TD
    subgraph Loop [1フレームの処理 60FPS]
        direction TB
        A[イベント取得<br>pygame.event.get] --> B{QUIT?}
        B -->|Yes| Exit[ループ終了]
        B -->|No| C[入力状態取得<br>pygame.key.get_pressed]

        C --> D[プレイヤー更新]
        D --> D1[移動処理]
        D1 --> D2[壁との衝突判定]
        D2 --> D3[位置確定]

        D3 --> E[純鬼更新]
        E --> E1{純鬼出現条件?}
        E1 -->|Yes| E2[純鬼をスポーン]
        E1 -->|No| E3[既存純鬼の追跡AI]
        E2 --> E3
        E3 --> E4[純鬼の座標更新]

        E4 --> F[衝突判定]
        F --> F1[プレイヤー vs 純鬼]
        F1 --> F2{接触?}
        F2 -->|Yes| F3[ゲームオーバーフラグ]
        F2 -->|No| F4[プレイヤー vs アイテム]
        F4 --> F5[プレイヤー vs ドア]
        F5 --> F6[マップ遷移トリガー]

        F3 --> G
        F6 --> G[イベント判定]
        G --> G1[純鬼出現トリガー]
        G1 --> G2[選択肢表示トリガー]
        G2 --> G3[謎解き成功トリガー]

        G3 --> H[描画処理]
        H --> H1[マップ描画]
        H1 --> H2[プレイヤー描画]
        H2 --> H3[純鬼描画]
        H3 --> H4[UI 描画]
        H4 --> H5[画面更新<br>pygame.display.flip]

        H5 --> I[サウンド更新]
        I --> I1[BGM 状態確認]
        I1 --> I2[SE 再生キュー処理]

        I2 --> J[フレームレート制御<br>Clock.tick 60]
        J --> K{ループ継続?}
        K -->|Yes| A
        K -->|No| Exit
    end
```

---

## 3. プレイヤー処理フロー

```mermaid
flowchart TD
    subgraph PlayerUpdate [プレイヤー更新処理]
        P1[入力取得] --> P2{押下キー}
        P2 -->|上| P3[dy = -speed]
        P2 -->|下| P4[dy = +speed]
        P2 -->|左| P5[dx = -speed]
        P2 -->|右| P6[dx = +speed]

        P3 --> P7[仮の新座標計算<br>new_x, new_y]
        P4 --> P7
        P5 --> P7
        P6 --> P7

        P7 --> P8[壁との衝突判定]
        P8 --> P9{壁に衝突?}
        P9 -->|Yes| P10[移動キャンセル]
        P9 -->|No| P11[座標更新]

        P10 --> P12[次の処理へ]
        P11 --> P12
    end
```

---

## 4. 純鬼（敵）追跡 AI フロー

```mermaid
flowchart TD
    subgraph JunkiAI [純鬼 追跡処理]
        J1[純鬼の現在位置] --> J2[プレイヤーとの距離計算<br>dx = px - jx, dy = py - jy]
        J2 --> J3[距離を正規化]
        J3 --> J4[移動方向ベクトル取得]

        J4 --> J5[純鬼の速度で移動量計算]
        J5 --> J6[壁との衝突判定]
        J6 --> J7{壁に衝突?}
        J7 -->|Yes| J8[別経路 or 停止]
        J7 -->|No| J9[純鬼の座標更新]

        J8 --> J10[次のフレームへ]
        J9 --> J10

        J10 --> J11{プレイヤーとの距離 < 接触判定?}
        J11 -->|Yes| J12[ゲームオーバー判定]
        J11 -->|No| J13[継続]
    end
```

---

## 5. アイテム取得・謎解きフロー

```mermaid
flowchart TD
    subgraph ItemPuzzle [アイテム・謎解き]
        IP1[プレイヤーがアイテムに接触] --> IP2{アイテム種別}
        IP2 -->|取得品| IP3[インベントリに追加]
        IP2 -->|鍵付きドア| IP4{所持アイテムに<br>対応する鍵?}
        IP2 -->|謎解きオブジェクト| IP5[謎解きUI表示]

        IP3 --> IP6[アイテムをマップから削除]
        IP6 --> IP7[取得SE再生]
        IP7 --> IP8[イベントトリガー確認<br>例: 純鬼出現]

        IP4 -->|Yes| IP9[扉を開く]
        IP4 -->|No| IP10[「鍵が無い」表示]
        IP9 --> IP11[部屋遷移]

        IP5 --> IP12{正解?}
        IP12 -->|Yes| IP13[フラグ設定<br>鍵などを出現]
        IP12 -->|No| IP14[再入力待ち]
        IP13 --> IP15[謎解きUI閉じる]
    end
```

---

## 6. セーブ/ロード フロー

```mermaid
flowchart TD
    subgraph Save [セーブ処理]
        S1[セーブポイント到達] --> S2[DB接続<br>sqlite3.connect]
        S2 --> S3[現在のゲーム状態を取得]
        S3 --> S4[プレイヤー位置<br>所持アイテム<br>進行フラグ<br>マップID]
        S4 --> S5[UPDATE or INSERT]
        S5 --> S6[commit]
        S6 --> S7[「セーブしました」表示]
    end

    subgraph Load [ロード処理]
        L1[メニューでロード選択] --> L2[DB接続]
        L2 --> L3[SELECT セーブデータ]
        L3 --> L4{データ存在?}
        L4 -->|No| L5[「セーブがありません」]
        L4 -->|Yes| L6[プレイヤー位置復元]
        L6 --> L7[インベントリ復元]
        L7 --> L8[進行フラグ復元]
        L8 --> L9[マップ・純鬼状態復元]
        L9 --> L10[ゲームループ開始]
    end
```

---

## 7. エンディング分岐フロー

```mermaid
flowchart TD
    E1[脱出地点に到達] --> E2{サキのペンダント<br>所持?}
    E2 -->|No| E3[ノーマルエンド条件]
    E2 -->|Yes| E4{地下室で<br>純鬼に触れた?}

    E4 -->|Yes| E5[「覚悟」トゥルーエンド]
    E4 -->|No| E3

    E5 --> E6[サキの記憶シーン表示]
    E6 --> E7[エンディング画面]

    E3 --> E8[「脱出」ノーマルエンド]
    E8 --> E7

    E9[ゲームオーバー<br>一定条件] --> E10[「囚われ」バッドエンド]
    E10 --> E7

    E7 --> E11[タイトルへ戻る]
```

---

## 8. モジュール依存関係（呼び出し関係）

```mermaid
flowchart LR
    main[main.py] --> game[game.py]
    game --> player[player.py]
    game --> junki[junki.py]
    game --> map[map/]
    game --> puzzle[puzzle/]
    game --> db[db/]
    game --> ui[ui/]

    player --> map
    junki --> map
    puzzle --> db
    game --> db
```

---

## 補足

- **Mermaid**（以下）: Markdown 内でフロー図を記述。GitHub、Cursor 等でプレビュー可能
- **draw.io**: `diagrams/` フォルダの `.drawio` ファイルを diagrams.net で開いて編集可能。PNG/SVG 等でエクスポート可能
- オンラインビューワ: [Mermaid Live Editor](https://mermaid.live/)

---

*純鬼 処理フロー図 v1.0*
