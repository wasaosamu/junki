# 次の実装（フロー図に沿ったやること）

> いまどこまでできていて、次に**フロー図のどこ**を**なぜ**実装するか、**何を**書くかを明示する。

---

## 1. フロー図の「ここ」でやる

**01_全体フロー** の **「タイトル画面」** から出ている **3本の矢印** を、コードでつなぐ。

- **「はじめる」** → 新規ゲーム開始（メインゲームループへ）
- **「つづきから」** → セーブデータロード（今回は未実装でよい）
- **「終了」** → 終了処理（Quit → pygame.quit）

つまり「タイトル画面のときに、どのキーが押されたかで分岐する」処理が未実装。

---

## 2. なぜここを実装する必要があるか

- **現状**: `self.state` と `game_start()` はあるが、
  - タイトルで **Enter / L / Q を押しても何も起きない**（イベントでキーを見ていない）
  - **描画が常にタイトル**のまま（`self.state` で分岐していない）
- **あるべき姿**: フロー図どおり「はじめる」で NewGame → メインゲームループに入り、画面もプレイ中用に切り替わる。
- **理由**: タイトルとプレイ中を「状態で切り替える」ところがつながっていないと、その先のマップ・プレイヤー実装をしても「はじめる」で入れない。まず **01_全体フローのタイトル分岐** をコードでつなぐ必要がある。

---

## 3. どんな実装が必要か

### 3.1 やること一覧

| 番号 | 内容 | 場所 |
|------|------|------|
| ① | タイトル中だけキー入力（Enter / L / Q）を判定する | `game.py` の `run()` 内、イベントループ |
| ② | Enter で `game_start()` を呼ぶ（新規ゲーム開始） | 同上 |
| ③ | Q で終了（QUIT イベントを投げるか `running = False`） | 同上 |
| ④ | 描画を `self.state` で分岐する（タイトル or プレイ中） | `game.py` の `run()` 内、描画部分 |
| ⑤ | プレイ中用の「仮の描画」を用意する（黒画面や「プレイ中」の文字でよい） | `game.py` の新メソッド or `ui/draw.py` |

### 3.2 実装の詳細

#### ①〜③ イベント処理（run() の for event in ... の中）

- `event.type == pygame.KEYDOWN` のときだけ処理する。
- さらに **`self.state == STATE_TITLE`** のときだけ、キーで分岐する。
  - **Enter**（`event.key == pygame.K_RETURN`）→ `self.game_start()` を呼ぶ。
  - **Q**（`event.key == pygame.K_q`）→ `pygame.event.post(pygame.event.Event(pygame.QUIT))` で終了させる（または `running = False`）。
  - **L**（`event.key == pygame.K_l`）→ いまは何もしない（「つづきから」は Phase 6 で実装）。

これで **01_全体フロー** の「はじめる」「終了」の矢印がコード上でつながる。

#### ④ 描画の分岐（run() の描画部分）

- いまの **`self._draw_title()` を常に呼ぶ** のではなく、
  - **`self.state == STATE_TITLE`** のとき → `self._draw_title()` を呼ぶ。
  - **`self.state == STATE_PLAYING`** のとき → プレイ中用の描画を呼ぶ（下の ⑤）。

#### ⑤ プレイ中用の仮描画

- **02_メインゲームループ** の H（描画処理）では、のちに H1 マップ→H2 プレイヤー→H3 純鬼→H4 UI とつなぐが、いまは **プレイ中であることが分かればよい** ので、
  - 例: 画面を黒で塗りつぶし、中央に「プレイ中」と表示するだけの関数を用意する。
  - 場所: `game.py` に `_draw_playing()` を追加し、中で `screen.fill(COLOR_BLACK)` と `font.render("プレイ中", ...)` + `blit` でもよい。または `ui/draw.py` に `draw_playing_placeholder(screen, font)` を追加し、`game.py` から呼んでもよい。

---

## 4. フロー図との対応まとめ

| フロー図 | 実装でやること |
|----------|----------------|
| 01_全体フロー「タイトル」→「はじめる」 | Enter で `game_start()` を呼ぶ（①②） |
| 01_全体フロー「タイトル」→「終了」 | Q で QUIT または `running = False`（③） |
| 01_全体フロー「はじめる」→「メインゲームループ」 | `game_start()` で `self.state = STATE_PLAYING` にし、run() の描画でプレイ中を表示（④⑤） |
| 02_メインゲームループ「描画処理」 | 状態に応じてタイトル or プレイ中を描画（④）。中身は後で H1〜H4 に拡張 |

---

## 5. このあとに続く実装（参考）

- 上記ができたら、**02_メインゲームループ** の **C（入力）→ D（プレイヤー更新）→ H1（マップ描画）→ H2（プレイヤー描画）** に進む（Phase 2: マップ・プレイヤー）。
- 処理チェックリストでは **Phase 8.2「メニュー選択と遷移処理」** に該当する。

---

*次の実装 v1.0*
